---
title: "Project Two"
format: html
editor: visual
---

## Quarto

Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.

## Running Codef

When you click the **Render** button a document will be generated that includes both content and the output of embedded code. You can embed code like this:

```{r}
library(tidyr)
library(tidyverse)
library(readxl)
library(DT)
project2_1_ <- read_excel("project2 (1).xls")
View(project2_1_)
str(project2_1_)
print(project2_1_)
#Produce numerical and graphical summaries to investigate the data

# One-way and Two-way contingency tables
project2_1_ |>
  #Regions
  drop_na(Region) |>
  group_by(Region) |>
  summarize(count = n()) 

 

#State
project2_1_ |>
 drop_na(`State`) |>
  group_by(`State`) |>
  summarize(count = n())

#City
project2_1_ |>
 drop_na(`City`) |>
  group_by(`City`) |>
  summarize(count = n())


#Segment
project2_1_ |>
 drop_na(`Segment`) |>
  group_by(`Segment`) |>
  summarize(count = n())


#Category
project2_1_ |>
 drop_na(`Category`) |>
  group_by(`Category`) |>
  summarize(count = n())

#Sub-Category
project2_1_ |>
 drop_na(`Sub-Category`) |>
  group_by(`Sub-Category`) |>
  summarize(count = n())

#Product Name
project2_1_ |>
 drop_na(`Product Name`) |>
  group_by(`Product Name`) |>
  summarize(count = n())


project2_1_ |>
  drop_na(State, City) |>
  group_by(State, City) |>
  summarize(count = n())



project2_1_ |>
  drop_na(Region, State) |>
  group_by(Region, State) |>
  summarize(count = n())

project2_1_ |>
  drop_na(Category, `Sub-Category`) |>
  group_by(Category, `Sub-Category`) |>
  summarize(count = n())



project2_1_ |>
  drop_na(State, `Category`) |>
  group_by(State, `Category`) |>
  summarize(count = n())



project2_1_ |>
  drop_na(Region, `Category`) |>
  group_by(Region, `Category`) |>
  summarize(count = n())

#Stacked Bar Graph
ggplot(data = project2_1_ |>
 group_by(Region, `Category`) |>
 summarize(count = n()), aes(x = Region, y = count, fill = Category)) +
 geom_bar(stat = "identity")+
  labs(title = "Number of Items in Each Category Region Stacked",
       x = "Region",
       y = "Count") +
  theme_minimal()

#Stacked Bar Graph
ggplot(data = project2_1_ |>
  drop_na(State, Segment) |>
  group_by(State, Segment) |>
  summarize(count = n()), aes(x = State, y = count, fill = Segment)) +
 geom_bar(stat = "identity")+
  labs(title = "Number of each Segment by State",
       x = "State",
       y = "Count") +
  theme_minimal()


#Stacked Bar Graph
ggplot(data = project2_1_ |>
  drop_na(Segment, Category) |>
  group_by(Segment, Category) |>
  summarize(count = n()), aes(x = Segment, y = count, fill = Category)) +
 geom_bar(stat = "identity")+
  labs(title = "Number of Each Category by Segment",
       x = "Segment",
       y = "Count") +
  theme_minimal()


```

Numeric Summaries

```{r}
 project2_1_ |>
  group_by(Segment)|>
  summarize(across(c( Sales, Quantity, Discount, Profit), 
                   list("mean" = mean, "median" = median, "standard deviation"=sd), 
                   .names = "{.fn}_{.col}"))

 project2_1_ |>
  group_by(State)|>
  summarize(across(c( Sales, Quantity, Discount, Profit), 
                   list("mean" = mean, "median" = median, "standard deviation"=sd), 
                   .names = "{.fn}_{.col}"))
 project2_1_ |>
  group_by(City)|>
  summarize(across(c( Sales, Quantity, Discount, Profit), 
                   list("mean" = mean, "median" = median, "standard deviation"=sd), 
                   .names = "{.fn}_{.col}"))
 
  project2_1_ |>
  group_by(Category)|>
  summarize(across(c( Sales, Quantity, Discount, Profit), 
                   list("mean" = mean, "median" = median, "standard deviation"=sd), 
                   .names = "{.fn}_{.col}"))

    project2_1_ |>
  group_by(Region)|>
  summarize(across(c( Sales, Quantity, Discount, Profit), 
                   list("mean" = mean, "median" = median, "standard deviation"=sd), 
                   .names = "{.fn}_{.col}"))
    
    
    project2_1_ |>
  group_by(`Sub-Category`)|>
  summarize(across(c( Sales, Quantity, Discount, Profit), 
                   list("mean" = mean, "median" = median, "standard deviation"=sd), 
                   .names = "{.fn}_{.col}"))
    
    #Create a histogram-Distribution of Age by Sex

ggplot(project2_1_ , aes(x = Sales, fill = Region)) +
  geom_histogram(alpha = 0.5, position = "dodge", bins = 15) +
  labs(
    title = "Distribution Sales by Region",
    x = "Sales",
    y = "Count",
    fill = "Region"
  )
ggplot(project2_1_, aes(x = Discount, fill = Segment)) +
  geom_density(alpha = 0.5, position = "dodge") +
  labs(
    title = "Distribution Sales by Region",
    x = "Discont",
    y = "Count",
    fill = "Segment"
  )

ggplot(project2_1_, aes(x = Quantity, fill = Category)) +
  geom_density(alpha = 0.5, position = "dodge") +
  labs(
    title = "Distribution Quantity by Category",
    x = "Quantity",
    y = "Count",
    fill = "Category"
  )
```

##Shiny App Creation
```{r}
library(shiny)
library(shinyalert)
library(tidyverse)
library(readxl)

# Load sample data outside the UI
my_sample <- read_excel("project2 (1).xls")

# Define UI
ui <- fluidPage(
  "Add a title panel here!",
  sidebarLayout(
    sidebarPanel(
      h2("Select Region:"),
     checkboxGroupInput(
        inputId = "cat_region",
        label = "Region",
        choices = list(
          "Central",
          "East",
          "South",
          "West"
        ),
        selected = "Central"
      ),
      h2("Select Segment:"),
     checkboxGroupInput(
        inputId = "cat_segment",
        label = "Segment",
        choices = list(
          "Consumer",
          "Corporate",
          "Home Office"

        ),
        selected = "Consumer"
      ),
      h2("Select First Numeric Variable:"),
      selectInput(
        inputId = "num_first",
        label = "Numeric Variable",
        choices = list(
          "Sales",
          "Quantity",
          "Discount",
          "Profit"
        ),
        selected = "Sales"
      ),

      # Dynamic slider #1 goes here
      uiOutput("num_first_slider"),
     
     
      h2("Select Second Numeric Variable:"),
      selectInput(
        inputId = "num_second",
        label = "Numeric Variable",
        choices = list(
          "Sales",
          "Quantity",
          "Discount",
          "Profit"
        ),
        selected = "Sales"
      ),
        # Dynamic slider #2 goes here
      uiOutput("num_second_slider"),
     
     

      actionButton("subset_btn", "Subset Data")
    ),

    mainPanel(
      tabsetPanel(
        tabPanel(
          title = "About My App!",
          h3("Welcome to the Superstore Sales App!"),
          p("This dataset gives insights on online orders of a US superstore from 2014-2018."),
          p("In the sidebar you have widgets that allow you to subset the data. In the app main panel Data Download tab you can download the data or data subset. In the Data Exploration tab you can obtain numeric and graphical summaries of the data."),
          tags$a(href = "https://www.kaggle.com/datasets/juhi1994/superstore/discussion?sort=hotness", "Link to data source")
        ),
        tabPanel(
          title = "Data Download",
          h3("Dataset on Online Orders of a US Superstore from 2014-2018.")
        ),
        tabPanel(
          title = "Data Exploration",
          h3("Here you can explore the data with numeric and graphical summaries!"),
          radioButtons(
            inputId = "summary_type",
            label = "Choose summary type:",
            choices = c("Categorical" = "cat", "Numeric" = "num"),
            selected = "cat"
          ),

          # Let user choose what they want to see
            radioButtons(
            inputId = "explore_options",
            label = "Select what to display:",
            choices = c("Table" = "table", "Plot" = "plot"),
            selected = NULL
          ),

          
          # Dynamic UI for table/plot controls (radio buttons, checkboxes, etc.)
uiOutput("explore_controls"),

# Placeholders for conditional "Group by" selectors
uiOutput("cat_group_ui"),  # Only appears if categorical stacked bar is selected
uiOutput("num_group_ui"),  # Only appears if numeric boxplot is selected

# Placeholder for the actual outputs
uiOutput("explore_outputs"),


# Placeholders for tables and plots
tableOutput("oneway_table_segment"),
tableOutput("oneway_table_region"),
tableOutput("two_way_table"),
uiOutput("cat_plot_ui"),
uiOutput("num_plot_ui_first"),
uiOutput("num_plot_ui_second"),
tableOutput("summary_stats")

        )
      )
    )
  )
)

# Define server
server <- function(input, output, session) {


  # Dynamic slider based on numeric variable
  output$num_first_slider <- renderUI({
    req(input$num_first)
    if (input$num_first == "Sales") {
      sliderInput("num_first_slider",
                  label = "Set value range",
                  min = 0, max = 22700, value = c(0, 22700))
    } else if (input$num_first == "Quantity") {
      sliderInput("num_first_slider",
                  label = "Set value range",
                  min = 1, max = 14, value = c(1, 14))
    } else if (input$num_first == "Discount") {
      sliderInput("num_first_slider",
                  label = "Set value range",
                  min = 0, max = 0.8, value = c(0, 0.8))
    } else {  # Profit
      sliderInput("num_first_slider",
                  label = "Set value range",
                  min = -6600, max = 8400, value = c(-6600, 8400))
    }
  })
  
   # Dynamic slider based on numeric variable
  output$num_second_slider <- renderUI({
    req(input$num_second)
    if (input$num_second == "Sales") {
      sliderInput("num_second_slider",
                  label = "Set value range",
                  min = 0, max = 22700, value = c(0, 22700))
    } else if (input$num_second == "Quantity") {
      sliderInput("num_second_slider",
                  label = "Set value range",
                  min = 1, max = 14, value = c(1, 14))
    } else if (input$num_second == "Discount") {
      sliderInput("num_second_slider",
                  label = "Set value range",
                  min = 0, max = 0.8, value = c(0, 0.8))
    } else {  # Profit
      sliderInput("num_second_slider",
                  label = "Set value range",
                  min = -6600, max = 8400, value = c(-6600, 8400))
    }
  })
  

  # Reactive subset
  subset_data <- eventReactive(input$subset_btn, {
    req(input$num_first_slider)

    data <- my_sample %>%
      filter(Region %in% input$cat_region,
             Segment %in% input$cat_segment)

    num_var <- input$num_first
    slider_vals <- input$num_first_slider

    data <- data %>%
      filter(.data[[num_var]] >= slider_vals[1],
             .data[[num_var]] <= slider_vals[2])

    data
  })

output$explore_controls <- renderUI({
  req(input$explore_options)  # Make sure user has selected table or plot

  ui_list <- list()
  
  # Table controls
  if ("table" %in% input$explore_options) {
    if (input$summary_type == "cat") {
      ui_list <- append(ui_list, list(
        checkboxGroupInput("table_type_cat", "Choose type(s) of table:",
                           choices = c("One-way table" = "one_way",
                                       "Two-way table" = "two_way"),
                           selected = "one_way"))
      )
    } else if (input$summary_type == "num") {
      ui_list <- append(ui_list, list(
        checkboxGroupInput("table_type_num", "Choose summary statistics:",
                           choices = c("Mean" = "mean",
                                       "Median" = "median",
                                       "Standard Deviation" = "sd"),
                           selected = c("mean", "median"))
      ))
    }
  }

  # Plot controls
  if ("plot" %in% input$explore_options) {
    if (input$summary_type == "cat") {
      # Radio buttons for categorical plots
      ui_list <- append(ui_list, list(
        radioButtons("cat_plot_type", "Choose plot type:",
                     choices = c("Bar Chart" = "bar", "Stacked Bar Chart" = "stacked"),
                     selected = "bar"),
        # Conditional Group by selector for stacked bars
        uiOutput("cat_group_ui")
      ))
    } else if (input$summary_type == "num") {
      # Radio buttons for numeric plots
      ui_list <- append(ui_list, list(
        radioButtons("num_plot_type", "Choose plot type:",
                     choices = c("Histogram" = "hist", "Boxplot" = "box", "Density Plot" = "density"),
                     selected = "hist"),
        # Conditional Group by selector for boxplots
        uiOutput("num_group_ui")
      ))
    }
  }

  do.call(tagList, ui_list)
})




# Conditional Group by UI for categorical plots
output$cat_group_ui <- renderUI({
  req(input$cat_plot_type)
  if (input$cat_plot_type == "stacked") {
    selectInput("cat_group", "Group by:",
                choices = c("Selected Regions", "Selected Segments"),
                selected = "Selected Regions")
  }
})

# Conditional Group by UI for numeric plots
output$num_group_ui <- renderUI({
  req(input$num_plot_type)
  if (input$num_plot_type == "box") {
    selectInput("num_group", "Group by:",
                choices = c("Selected Regions", "Selected Segments"),
                selected = "Selected Regions")
  }
})
#Categorical Table Outputs 

# ONE-WAY tables
output$oneway_table_segment <- renderTable({
  req(subset_data())
  req(input$summary_type == "cat",
      input$explore_options == "table",
      "one_way" %in% input$table_type_cat)
  
  data <- subset_data()
  
  data |>
    count(Segment) |>
    rename(Count = n)
})

output$oneway_table_region <- renderTable({
  req(subset_data())
  req(input$summary_type == "cat",
      input$explore_options == "table",
      "one_way" %in% input$table_type_cat)
  
  data <- subset_data()
  
  data %>%
    count(Region) %>%
    rename(Count = n)
})


# TWO-WAY table
output$two_way_table <- renderTable({
  req(subset_data())
  req(input$summary_type == "cat",
      input$explore_options == "table",
    "two_way" %in% input$table_type_cat)
  
  data <- subset_data()
  
  data %>%
    count(Region, Segment) %>%
    pivot_wider(
      names_from = Segment,
      values_from = n,
      values_fill = 0
    )
})

# REGULAR bar for Region
output$bar_region <- renderPlot({
  req(subset_data())
  data <- subset_data()

  data |>
    count(Region) |>
    ggplot(aes(x = Region, y = n)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    labs(x = "Region", y = "Count") +
    theme_minimal()
})

# REGULAR bar for Segment
output$bar_segment <- renderPlot({
  req(subset_data())
  data <- subset_data()

  data |>
    count(Segment) |>
    ggplot(aes(x = Segment, y = n)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    labs(x = "Segment", y = "Count") +
    theme_minimal()
})

# STACKED bar with user choice
output$bar_stacked <- renderPlot({
  req(subset_data(), input$cat_group)
  data <- subset_data()

  fill_var <- ifelse(input$cat_group == "Selected Regions", "Region", "Segment")
  x_var <- ifelse(fill_var == "Region", "Segment", "Region")

  data |>
    count(.data[[x_var]], .data[[fill_var]]) |>
    ggplot(aes(x = .data[[x_var]], y = n, fill = .data[[fill_var]])) +
    geom_bar(stat = "identity") +
    labs(x = x_var, y = "Count", fill = fill_var) +
    theme_minimal()
})
output$cat_plot_ui <- renderUI({
  req(input$summary_type == "cat",
      input$explore_options == "plot",
      !is.null(input$cat_plot_type))

  if (input$cat_plot_type == "bar") {
    tagList(
      plotOutput("bar_region"),
      plotOutput("bar_segment")
    )
  } else if (input$cat_plot_type == "stacked") {
    plotOutput("bar_stacked")
  }
})
# Helper function to avoid duplication
render_numeric_plot <- function(num_var, plot_type, plot_id) {
  output[[plot_id]] <- renderPlot({
    req(subset_data(), num_var, input$num_group)
    data <- subset_data()
    fill_var <- ifelse(input$num_group == "Selected Regions", "Region", "Segment")
    x_var <- fill_var  # for boxplot

    if (plot_type == "hist") {
      data |>
        ggplot(aes(x = .data[[num_var]], fill = .data[[fill_var]])) +
        geom_histogram(alpha = 0.5, position = "dodge", bins = 15) +
        labs(x = num_var, y = "Count", fill = fill_var) +
        theme_minimal()
    } else if (plot_type == "box") {
      data |>
        ggplot(aes(x = .data[[x_var]], y = .data[[num_var]], fill = .data[[x_var]])) +
        geom_boxplot() +
        labs(x = x_var, y = num_var, fill = x_var) +
        theme_minimal()
    } else if (plot_type == "density") {
      data |>
        ggplot(aes(x = .data[[num_var]], fill = .data[[fill_var]])) +
        geom_density(alpha = 0.5) +
        labs(x = num_var, y = "Density", fill = fill_var) +
        theme_minimal()
    }
  })
}
observe({
  req(input$num_plot_type, input$num_first, input$num_second)

  render_numeric_plot(input$num_first, input$num_plot_type, paste0("num_", input$num_plot_type, "_first"))
  render_numeric_plot(input$num_second, input$num_plot_type, paste0("num_", input$num_plot_type, "_second"))
})









# First numeric variable
output$num_plot_ui_first <- renderUI({
  req(input$summary_type == "num", input$explore_options == "plot", input$num_plot_type)
  
  if (input$num_plot_type == "hist") {
    plotOutput("num_hist_first")
  } else if (input$num_plot_type == "box") {
    plotOutput("num_box_first")
  } else if (input$num_plot_type == "density") {
    plotOutput("num_density_first")
  }
})

# Second numeric variable
output$num_plot_ui_second <- renderUI({
  req(input$summary_type == "num", input$explore_options == "plot", input$num_plot_type)
  
  if (input$num_plot_type == "hist") {
    plotOutput("num_hist_second")
  } else if (input$num_plot_type == "box") {
    plotOutput("num_box_second")
  } else if (input$num_plot_type == "density") {
    plotOutput("num_density_second")
  }
})


output$summary_stats <- renderTable({
  req(subset_data(), input$summary_type == "num", input$explore_options == "table", input$num_group)
  
  data <- subset_data()
  
  # Decide grouping variable based on user selection
  group_var <- ifelse(input$num_group == "Selected Regions", "Region", "Segment")
  
  # Numeric variables to summarize
  num_vars <- c(input$num_first, input$num_second)
  
  # Summary by group
  grouped_stats <- data |>
    group_by(.data[[group_var]]) |>
    summarise(
      across(all_of(num_vars),
             list(
               Mean = ~mean(.x, na.rm = TRUE),
               Median = ~median(.x, na.rm = TRUE),
               SD = ~sd(.x, na.rm = TRUE),
               Min = ~min(.x, na.rm = TRUE),
               Max = ~max(.x, na.rm = TRUE)
             ),
             .names = "{col}_{fn}"
      )
    ) |>
    ungroup()
  
  # Summary for overall (all data)
  overall_stats <- data |>
    summarise(
      across(all_of(num_vars),
             list(
               Mean = ~mean(.x, na.rm = TRUE),
               Median = ~median(.x, na.rm = TRUE),
               SD = ~sd(.x, na.rm = TRUE),
               Min = ~min(.x, na.rm = TRUE),
               Max = ~max(.x, na.rm = TRUE)
             ),
             .names = "{col}_{fn}"
      )
    ) |>
    mutate(!!group_var := "Overall For Your Selected Subset") |>
    select(all_of(group_var), everything())
  
  # Combine grouped and overall stats
  bind_rows(grouped_stats, overall_stats)
})

}

# Run the application 
shinyApp(ui = ui, server = server)
```
